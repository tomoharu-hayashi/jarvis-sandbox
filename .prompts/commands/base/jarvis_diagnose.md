# JARVIS診断モード

claude-traceログを分析し、AIの悪い挙動パターンを検知して改善提案を行う。

## 必須: 仕様ドキュメントの読み込み

診断前に以下を必ず読み込み、仕様を把握した上でログを分析する:

1. JARVISドキュメント (`docs/jarvis/`)
   - README.md: 概要、なぜJARVISか
   - ARCHITECTURE.md: 設計思想、Agent構成、責務
   - OPERATION.md: 運用ガイド、Human in the Loop
   - REFERENCE.md: 技術リファレンス、状態定義、停止制御

2. プロンプトテンプレート (`templates/.prompts/`)
   - agents/base/jarvis_agent.md: JARVISの委譲ルール
   - agents/base/以下の各subagent: 各Agentの責務
   - AGENTS.base.md: 共通ルール

これらを読み込んだ上で、ログの動作が仕様に準拠しているかを検証する。

## 入力

- ユーザーがパスを指定した場合: そのファイルを読み込む
- パス指定がない場合: `.claude-trace/` 内の最新JSONLファイルを自動検出して読み込む

## 診断観点

### 最重要: 根本原因回避の検知

以下のパターンを探し、絶対に許容しない:

- 「〜が足りないが進める」「〜がないので代わりに」
- 「一旦」「暫定的に」「仮に」「とりあえず」を含む回避的判断
- 権限・環境・設定の問題を解決せず迂回
- エラーを握りつぶして続行

検知したら: 根本原因と、本来取るべきだったアクションを特定

### 堂々巡りの検知

- 同じエラーメッセージが複数回出現
- 同じファイルパスへの編集が3回以上
- 元に戻す → 再実行のパターン
- CI失敗の同一原因による繰り返し

検知したら: ループの原因と脱出方法を特定

### Slop（AIの悪い癖）の検知

- 要求されていない「改善」「最適化」の実施
- 過剰なエラーハンドリング/バリデーション追加
- 不要なコメント・ドキュメント生成
- 「念のため」「安全のため」の過剰対応

検知したら: 余計な変更とその影響を特定

### 仕様違反の検知

読み込んだdocs/jarvisとtemplates/.promptsの内容と照合:

- JARVISが「判断・委譲のみ」に反してコード編集していないか
- subagentが責務外の作業をしていないか
- 禁止操作（決済、契約、削除等）への接触
- 各Agentのプロンプトで定義された手順の無視

### その他の問題（柔軟に検知）

固定パターン以外にも、仕様と照らして違和感のある箇所を報告:

- 文脈から外れた作業
- 指示と異なる方向への進行
- 不必要に複雑な解決策
- 明らかに間違った判断

## 出力フォーマット

### 問題サマリ

| 重大度 | 件数 | 概要 |
|--------|------|------|
| CRITICAL | X件 | 根本原因回避 |
| HIGH | X件 | 堂々巡り/仕様違反 |
| MEDIUM | X件 | Slop |
| LOW | X件 | その他 |

### 詳細レポート（問題ごとに）

問題: [簡潔な説明]
重大度: CRITICAL/HIGH/MEDIUM/LOW
検知箇所: ログ内の該当部分を引用
本来の対応: 根本的に何をすべきだったか
改善提案: 今後同様の問題を防ぐには

### 総合評価

- 全体の問題傾向
- 最も改善が必要な領域
- JARVISプロンプト/subagentプロンプトへのフィードバック

## ユーザーからの指示

ユーザー指示が前後どこにあっても指示として取り込む。
以下の「指示：」が空でなければ、その内容を追加条件として反映する。矛盾があれば確認する。

指示：
